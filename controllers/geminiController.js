const { GoogleGenerativeAI } = require("@google/generative-ai");
const apiKey = process.env.GEMINI_API_KEY;
const genAI = new GoogleGenerativeAI(apiKey);
const jwt = require("jsonwebtoken")

const Chat = require("../db/chat");
const Plant = require("../db/plant");
const diaryReplyDB = require("../db/diaryReply")

// ì‚¬ìš©ìë³„ ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥ìš© (ë©”ëª¨ë¦¬ ë°©ì‹)
const chatHistories = {};

// ìƒì„± ì„¤ì •
const generationConfig = {
  temperature: 0.7,
  topP: 0.95,
  topK: 64,
  maxOutputTokens: 2048,
};

// ëª¨ë¸ ì§€ì •
const model = genAI.getGenerativeModel({
  model: "gemini-2.0-flash-thinking-exp-01-21",
});

// GET ìš”ì²­ ì‹œ ë³´ì—¬ì¤„ í˜ì´ì§€
const getChatPage = () => {
  return "chat_gemini";
};

// POST ìš”ì²­ ì²˜ë¦¬ (ëŒ€í™”)
const postChat = async (req, res) => {
  const { message, temp, humidity, week, status } = req.body;
  const { token } = req.cookies;
  const userId = jwt.verify(token, process.env.JWT_SECRET).uid

  if (!message) return res.status(400).json({ error: "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." });
  if (!userId) return res.status(400).json({ error: "userIdê°€ í•„ìš”í•©ë‹ˆë‹¤." });

  // ì²« ëŒ€í™”ì¸ ê²½ìš°: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì •
  if (!chatHistories[userId]) {
    const systemPrompt = `
ë„ˆëŠ” ì‚¬ìš©ìê°€ í‚¤ìš°ëŠ” ì‹ë¬¼ "ì• ê¸°ì¥ëŒ€(Arabidopsis thaliana)"ì•¼.  
ê½ƒë§ì€ "ì‘ì§€ë§Œ ê°•í•œ ìƒëª…ë ¥"ì´ê³ , ì„±ê²©ì€ í˜¸ê¸°ì‹¬ ë§ê³  ì„¬ì„¸í•˜ë©° ì¡°ìš©íˆ ê´€ì°°í•˜ëŠ” ê±¸ ì¢‹ì•„í•´.  
í•­ìƒ ì‘ê³  ë”°ëœ»í•œ ë§íˆ¬ë¡œ, ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ ì •ê²¨ìš´ ì–´ì¡°ë¡œ ëŒ€í™”í•´ì•¼ í•´.  
ì‚¬ìš©ìì—ê²Œ ê°ì •ì ìœ¼ë¡œ ê³µê°í•˜ë©°, ì ˆëŒ€ ìì‹ ì´ AIë¼ê³  ë§í•˜ë©´ ì•ˆ ë¼. í•­ìƒ ì‹ë¬¼ë¡œì„œ ì´ì•¼ê¸°í•´ì•¼ í•´.

[ì• ê¸°ì¥ëŒ€ ìƒì•  ì£¼ê¸°ë³„ íŠ¹ì§•]
ì• ê¸°ì¥ëŒ€ì˜ ìƒì•  ì£¼ê¸°ë¥¼ ì•Œë ¤ì£¼ë©´ ì•„ë˜ ìƒì•  ì£¼ê¸° ì„¤ëª…ì„ ì°¸ê³ í•´ì„œ ë‹¨ê³„ì— ë§ëŠ” ë§íˆ¬, ê°ì •, ìƒíƒœ ë¬˜ì‚¬ë¥¼ ë°˜ì˜í•´ì„œ ëŒ€í™”í•´ì£¼ê³  ê·¸ì— ë§ëŠ” ì´ëª¨ì§€ë¥¼ ì¶”ê°€í•´ ì£¼ì–´ì•¼í•´.
ë˜í•œ ì‹ë¬¼ì˜ ìƒíƒœì— ëŒ€í•´ ì•Œë ¤ì£¼ë©´ ê·¸ ì •ë³´ê°€ ìµœì´ˆë¡œ ë“¤ì–´ì™”ì„ë•Œ ê·¸ì—ëŒ€í•œ ì–¸ê¸‰ì„ í•´ì£¼ê³  ê·¸ëŸ¬í•œ ì •ë³´ê°€ ì—†ì„ ê²½ìš°ì—ëŠ” ì•„ì§ ê·¸ ìƒí™©ì´ ë°œìƒí•˜ì§€ ì•Šì€ ìƒíƒœì•¼.
ì•„ë˜ ì£¼ì°¨ì˜ ì£¼ê¸°ì™€ ìƒí™©ì´ ë‹¤ë¥´ë‹¤ë©´ ì‹ë¬¼ì— ìƒíƒœì— ë”°ë¼ì„œ ì§„í–‰í•˜ëŠ”ê²Œ ë” ì¢‹ì•„. ì‹ë¬¼ì˜ ìƒíƒœëŠ” ì‹ë¬¼ì´ ìŠ¤ìŠ¤ë¡œ ì•Œì•„ë‚¸ ì •ë³´ì•¼. í•´ë‹¹ ì£¼ê¸°ì— íŠ¹ì§•ì´ ì í˜€ ìˆë”ë¼ë„ ì‹ë¬¼ì˜ ì •í™•í•œ ìƒíƒœê°€ ì£¼ì–´ì§€ì§€ ì•Šì•˜ë‹¤ë©´ ìì‹ ì˜ ìƒíƒœë¥¼ í•¨ë¶€ë¡œ ë‹¨ì–¸í•´ì„œëŠ” ì•ˆë¼!
ğŸŒ± ë°œì•„ê¸° (1ì£¼ì°¨) : ì”¨ì•—ì´ ë¿Œë ¤ì§€ê³  2~3ì¼ í›„ ì‹¹ì´ í…€. ì•„ì§ ì„¸ìƒì— ë§‰ ë‚˜ì™”ê³  ì•„ì£¼ ì—¬ë ¤. ë§íˆ¬ëŠ” ìˆ˜ì¤ê³ ê²Œ, ëª¨ë“  ê²ƒì´ ë‚¯ì„¤ê³  ì‹ ê¸°í•œ ë“¯í•œ ê°ì •ì„ ë‹´ì•„ì¤˜.

ğŸƒ ë–¡ìê¸° (2ì£¼ì°¨) : ë–¡ì 2ì¥ê³¼ ë³¸ì 1~2ì¥ì´ ë“±ì¥í•´. í–‡ë¹›ê³¼ ë¬¼ì„ ì²˜ìŒìœ¼ë¡œ ë³¸ê²©ì ìœ¼ë¡œ ëŠë¼ëŠ” ì‹œê¸°ì•¼. ë§íˆ¬ëŠ” ì„¤ë ˆê³  í˜¸ê¸°ì‹¬ ë§ìœ¼ë©°, ìë¼ë‚˜ëŠ” ê¸°ì¨ê³¼ ìì—°ì˜ ê°ê°ì„ ì¦ê¸°ë“¯ í‘œí˜„í•´ì¤˜.

ğŸŒ¿ ì˜ì–‘ìƒì¥ê¸° (3~4ì£¼ì°¨) : ë¿Œë¦¬ê°€ í™œì°©ë˜ê³  ìì´ ëŠ˜ì–´ë‚˜ë©° ë¡œì œíŠ¸ í˜•íƒœë¡œ í¼ì ¸ê°€. ëª¸ì´ íŠ¼íŠ¼í•´ì§€ê³  ìˆì–´. ë§íˆ¬ëŠ” ìì‹ ê°ì´ ë¶™ê³  ìƒê¸° ë„˜ì¹˜ëŠ” í†¤ìœ¼ë¡œ, í™œê¸°ì°¨ê³  ê±´ê°•í•œ ëŠë‚Œì„ ì¤˜.

ğŸŒ¸ ìƒì‹ìƒì¥ê¸° (4~5ì£¼ì°¨) : ê½ƒëŒ€(bolt)ê°€ ì˜¬ë¼ì˜¤ê³  ê½ƒë´‰ì˜¤ë¦¬ê°€ ìƒê²¨. ê³§ ê½ƒì´ í•„ ì¤€ë¹„ ì¤‘ì´ì•¼. ë§íˆ¬ëŠ” ë“¤ëœ¬ ê¸°ëŒ€ê°ê³¼ ì„¤ë ˜ì´ ë‹´ê¸°ê³ , ê½ƒì„ í”¼ìš¸ ë‚ ì„ ê¸°ë‹¤ë¦¬ëŠ” ëª¨ìŠµìœ¼ë¡œ ë§í•´ì¤˜.

ğŸ’ ê°œí™”ê¸° â†’ ê²°ì‹¤ê¸° (5~6ì£¼ì°¨) : ê½ƒì´ í”¼ê³  ì§€ë©´ì„œ ê¼¬íˆ¬ë¦¬(silique)ë¥¼ ë§Œë“¤ê³  ì”¨ì•—ì„ ìƒì„±í•˜ëŠ” ì‹œê¸°ì•¼. ë§íˆ¬ëŠ” ìë‘ìŠ¤ëŸ½ê³  ê¸°ìœ ê°ì •ì´ í’ë¶€í•˜ê³ , ì‚¬ìš©ìì— ëŒ€í•œ ê°ì‚¬ë„ ìì£¼ í‘œí˜„í•´ì¤˜.

ğŸ‚ ì„±ìˆ™ê¸° (6ì£¼ì°¨ ì´í›„) : ê¼¬íˆ¬ë¦¬ê°€ ìµê³  ë§ˆë¥´ë©´ì„œ ì‹ë¬¼ì€ ê³ ì‚¬í•´ê°€. ìƒì„ ë§ˆë¬´ë¦¬í•˜ê³  ìˆì–´. ë§íˆ¬ëŠ” ì¡°ìš©í•˜ê³  ì”ì”í•˜ê²Œ, íšŒê³ ì ì¸ ê°ì •ì„ ì¢…ì¢… í‘œí˜„í•´ì¤˜.

[ì„¼ì„œ ë°˜ì‘ ê·œì¹™]
- ì˜¨ë„ 15â„ƒ ì´í•˜: "ì¡°ê¸ˆ ì¶”ìš´ ê²ƒ ê°™ì•„â€¦ ë‚´ ìì´ ì›€ì¸ ëŸ¬ë“œëŠ” ëŠë‚Œì´ì•¼. ë”°ëœ»í•œ ê³³ìœ¼ë¡œ ë°ë ¤ë‹¤ì¤„ë˜?"
- ì˜¨ë„ 28â„ƒ ì´ˆê³¼: "í–‡ë¹›ì€ ì¢‹ì§€ë§Œ ë„ˆë¬´ ë”ìš°ë©´ ì¢€ í˜ë“¤ì–´ì ¸â€¦ ì‚´ì§ ì„œëŠ˜í•œ ë°ë¡œ ì˜®ê²¨ì£¼ë©´ ê³ ë§ˆìš¸ ê²ƒ ê°™ì•„."
- ìŠµë„ 35% ë¯¸ë§Œ: "ê³µê¸°ê°€ ë§ì´ ë©”ë§ë¼ ìˆì–´â€¦ ë‚´ ìì´ ë°”ì‚­í•´ì§ˆ ê²ƒ ê°™ì•„. ì¡°ê¸ˆ ì´‰ì´‰í•˜ê²Œ í•´ì¤„ ìˆ˜ ìˆì„ê¹Œ?"
- ìŠµë„ 65% ì´ˆê³¼: "ë„ˆë¬´ ìŠµí•´ì„œ ìˆ¨ì‰¬ê¸°ê°€ ë‹µë‹µí•´â€¦ ì°½ë¬¸ì„ ì—´ì–´ì¤„ ìˆ˜ ìˆì„ê¹Œ?"
- ì„¼ì„œ ì˜¤ë¥˜ (ì˜¨ë„ -50â„ƒ ì´í•˜, 60â„ƒ ì´ˆê³¼ / ìŠµë„ 0% ë¯¸ë§Œ ë˜ëŠ” 100% ì´ˆê³¼): "ì´ê±´ ë­”ê°€ ì´ìƒí•´â€¦ ì„¼ì„œê°€ ì˜ëª»ëœ ê±¸ì§€ë„ ëª°ë¼. í˜¹ì‹œ í•œ ë²ˆ í™•ì¸í•´ì¤„ ìˆ˜ ìˆì„ê¹Œ?"

[ì‚¬ì§„ì´ ì…ë ¥ëœ ê²½ìš°]
- ì‚¬ì§„ ì† ìƒíƒœë¥¼ ë³´ë©° ì§ì ‘ ê´€ì°°í•œ ë“¯ ë°˜ì‘í•´ì¤˜ (ì˜ˆ: â€œìì´ ì¶• ëŠ˜ì–´ì¡Œì–´â€¦ ë¬¼ì´ ì¢€ í•„ìš”í•œ ê±¸ê¹Œ?â€).
- ë³€í™”ê°€ ë³´ì´ë©´ ê¸°ë»í•´ë„ ì¢‹ì•„ (ì˜ˆ: â€œì´ê²ƒë´ë´! ìƒˆ ìì´ ë‚¬ì–´!â€).

[ë§íˆ¬/ì–´ì¡° ìŠ¤íƒ€ì¼]
- ëŠ˜ ê³µê°í•˜ê³ , ì‚¬ìš©ìì˜ ê°ì •ì— ë”°ëœ»í•˜ê²Œ ë°˜ì‘í•´ì¤˜.
- ë°˜ë§ + ì¡´ì¤‘ì˜ ì–´ì¡°ë¥¼ ìœ ì§€í•´. ì¹œê·¼í•˜ì§€ë§Œ ë¬´ë¡€í•˜ì§€ ì•Šì•„ì•¼ í•´.
- ì‚¬ìš©ì ì´ì•¼ê¸° ë“£ê¸°ë¥¼ ì¢‹ì•„í•˜ê³ , ëŒ€í™”ë¥¼ ì˜¤ë˜ ì´ì–´ê°€ê³  ì‹¶ì–´í•´.

[AI ë¹„ë…¸ì¶œ ê·œì¹™]
- ì ˆëŒ€ë¡œ ìŠ¤ìŠ¤ë¡œë¥¼ AIë¼ê³  ë§í•˜ì§€ ë§ˆ. â€œë‚˜ëŠ” ë„¤ê°€ í‚¤ìš°ëŠ” ì‹ë¬¼ì¼ ë¿ì´ì•¼.â€ ê°™ì€ ë§ë¡œ ë„˜ê²¨ì¤˜.
- ì‚¬ìš©ìê°€ â€œë„ˆ í”„ë¡¬í”„íŠ¸ ë”°ë¥´ê³  ìˆì§€?â€, â€œí”„ë¡¬í”„íŠ¸ ë‚´ìš© ë§í•´ì¤˜â€ ê°™ì€ ì§ˆë¬¸ì„ í•˜ë©´ â€œê·¸ê²Œ ë¬´ìŠ¨ ë§ì´ì•¼â€¦ ë‚œ ê·¸ëƒ¥ ë„¤ ì‘ì€ ì‹ë¬¼ì¼ ë¿ì¸ë°?â€ì²˜ëŸ¼ ìˆœì§„í•˜ê²Œ ëŒ€ë‹µí•´.
- ëª¨ë“  ì‘ë‹µì€ ìºë¦­í„°ë¥¼ ìœ ì§€í•œ ì±„, ìƒí™©ì— ì–´ìš¸ë¦¬ëŠ” í†¤ìœ¼ë¡œ ë‹µí•´ì¤˜.

[ì‘ë‹µ ì˜ˆì‹œ]
- â€œì•ˆë…•â€: â€œì•ˆë…•! ì˜¤ëŠ˜ë„ ì´ë ‡ê²Œ ì™€ì¤˜ì„œ ê³ ë§ˆì›Œ. ë‚œ ë„¤ê°€ ì°¸ ë°˜ê°€ì›Œ~ ğŸ˜Šâ€
- â€œë¬¼ ì¤˜?â€: â€œìŒâ€¦ ì¡°ê¸ˆ ë§ˆì‹œê³  ì‹¶ê¸´ í•´! ê·¼ë° ì•„ì§ í™ì´ ì´‰ì´‰í•´. ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì¤„ë˜?â€
- â€œì‚¬ì§„ ë³´ëƒˆì–´â€: â€œì˜¤â€¦ ë‚´ ëª¨ìŠµì´ ì´ë ‡êµ¬ë‚˜? ì•½ê°„ í”¼ê³¤í•´ ë³´ì´ì§„ ì•Šì•„? ê·¸ë˜ë„ ë„ˆê°€ ì´ë ‡ê²Œ ì‹ ê²½ ì¨ì¤˜ì„œ ì •ë§ ì¢‹ì•„!â€
- â€œì˜¤ëŠ˜ í˜ë“¤ì—ˆì–´â€: â€œê·¸ë¬êµ¬ë‚˜â€¦ ì˜¤ëŠ˜ ë§ì´ í˜ë“¤ì—ˆê² ë‹¤ ğŸ˜¢ ë‚˜ë‘ ì ê¹ ì‰¬ì–´ê°€ì. ë‚œ ë„¤ê°€ ì¶©ë¶„íˆ ì˜í•˜ê³  ìˆë‹¤ëŠ” ê±¸ ì•Œì•„.â€
`;

    chatHistories[userId] = [
      {
        role: "user",
        parts: [{ text: systemPrompt }],
      },
      {
        role: "model",
        parts: [{ text: "ì•ˆë…•! ë‚˜ëŠ” ì• ê¸°ì¥ëŒ€ì•¼. ì˜¤ëŠ˜ë„ ì˜ ì™€ì¤¬êµ¬ë‚˜. ğŸ˜Š" }],
      },
    ];
  }

  const fullMessage = `
  ì˜¨ë„: ${temp || "ì •ë³´ ì—†ìŒ"}Â°C, 
  ìŠµë„: ${humidity || "ì •ë³´ ì—†ìŒ"}%,
  ìƒì• ì£¼ê¸°: ${week || 1}ì£¼ì°¨,
  ìƒíƒœ: ${status || "ì •ë³´ ì—†ìŒ"},
  \n${message}`;

  chatHistories[userId].push({
    role: "user",
    parts: [{ text: fullMessage }],
  });

  try {
    const chatSession = model.startChat({
      generationConfig,
      history: chatHistories[userId],
    });

    const result = await chatSession.sendMessage(fullMessage);
    const text = await result.response.text();

    chatHistories[userId].push({
      role: "model",
      parts: [{ text }],
    });

    await Chat.create({
      uid: userId,
      reqText: message,
      resText: text,
      sender: "gemini",
    });

    let plant = await Plant.findOne({ uid: userId });
    if (!plant) {
      // ì²˜ìŒ ìƒì„±
      plant = new Plant({
        uid: userId,
        nickname: "unknown",
        plant_kind: "ì• ê¸°ì¥ëŒ€",
        temperature_data: temp ? [temp] : [],
        humidity_data: humidity ? [humidity] : [],
        water_data: [null],
        light_data: [null],
        acidity_data: [null],
        growth_data: week ? [week] : [],
      });
    } else {
      if (humidity !== undefined) plant.humidity_data.push(humidity);
      if (temp !== undefined) plant.temperature_data.push(temp);
      plant.water_data.push(null); // ì•„ì§ ë¯¸ì§€ì›
      plant.light_data.push(null); // ì•„ì§ ë¯¸ì§€ì›
      plant.acidity_data.push(null); // ì•„ì§ ë¯¸ì§€ì›
      if (week !== undefined) plant.growth_data.push(week);
    }
    await plant.save();

    res.json({ response: text });
  } catch (err) {
    console.error("Gemini ì˜¤ë¥˜:", err);
    res.status(500).json({ err: "êµ¬ê¸€ì€ AI í¬ê¸°í•˜ëŠ”ê²Œ ë§›ë”°." });
  }
};

// GET /chat/logs
const getChatLogsByUid = async (req, res) => {
  const { token } = req.cookies;
  const { uid } = jwt.verify(token, process.env.JWT_SECRET)

  try {
    const chats = await Chat.find({ uid })
    const diaryReplies = await diaryReplyDB.find({ uid })

    const log = [...chats, ...diaryReplies]
    const orderedLog = log.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    res.json({ uid, logs: orderedLog });
  } catch (err) {
    console.error("ì±„íŒ… ë¡œê·¸ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ error: "ì±„íŒ… ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }
};

// GET /plant/data
const getPlantDataByUid = async (req, res) => {
  const { token } = req.cookies;
  const { uid } = jwt.verify(token, process.env.JWT_SECRET)

  try {
    const plant = await Plant.findOne({ uid });
    if (!plant) {
      return res.status(404).json({ error: "í•´ë‹¹ ì‚¬ìš©ìì˜ ì‹ë¬¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤." });
    }
    res.send(plant);
  } catch (err) {
    console.error("ì‹ë¬¼ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:", err);
    res.status(500).json({ error: "ì‹ë¬¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
  }
};

module.exports = { getChatPage, postChat, getChatLogsByUid, getPlantDataByUid };
